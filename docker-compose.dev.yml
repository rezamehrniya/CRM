# توسعه با داکر — هر تغییری در کد بدون ری‌بیلد دیده می‌شود
# استفاده: docker compose -f docker-compose.yml -f docker-compose.dev.yml up -d
# اپ: http://localhost:5173   API: http://localhost:3001

services:
  postgres:
    # همان سرویس اصلی (بدون تغییر)
    profiles: []

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    restart: "no"
    environment:
      DATABASE_URL: postgresql://sakhtar:sakhtar_secret@postgres:5432/sakhtar_crm
      PORT: 3000
      JWT_SECRET: ${JWT_SECRET:-CHANGE_ME_IN_PRODUCTION_MIN_32_CHARS}
    volumes:
      - ./backend/src:/app/src
      - ./backend/prisma:/app/prisma
    ports:
      - "3001:3000"
    depends_on:
      postgres:
        condition: service_healthy
    command: npm run start:dev

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    restart: "no"
    environment:
      VITE_API_PROXY_TARGET: http://backend:3000
    volumes:
      - ./frontend:/app
      - frontend_node_modules:/app/node_modules
    ports:
      - "5173:5173"
    depends_on:
      - backend
    command: sh -c "npm install && npm run dev"

volumes:
  postgres_data:
  frontend_node_modules:
